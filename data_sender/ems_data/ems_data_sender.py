# -*- coding: utf-8 -*-
import mysql.connector
import os
from operator import itemgetter
import shutil
import requests
#--------------------------------------------------------------------------------------------------
#INFORMANDO LOCAL DO ARQUIVO .txt
caminho = '/home/sodarec/data_sender/ems_data/'
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#INFORMANDO O DESTINO DOS ARQUIVOS
destino = '/home/sodarec/data_sender/ems_data/inseridos/'
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#INFOMADNO A URL PARA UPLOAD DOS ARQUIVOS
url = 'http://awaire-air-quality/api/v1/sms_llwas_observations'
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#LISTANDO AS ENTRADAS DO DIRETÓRIO caminho
entradas = os.listdir(caminho)
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#ARRAY COM NOMES DE ESTACOES DEFINIDAS NO txt
estacoes = ['EMQAM1E01', 'EMQAM2E02', 'EMQAM3E03'] # 'EMQAM1E01' = 2, 'EMQAM2E02' = 3, 'EMQAM3E03' = 4
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#LISTA DE TODAS VARIAVEIS DISPONIVEIS DENTRO DO ARQUIVO txt
variaveis = ['speed', 'direction', 'temperature', 'rain', 'wind_gust', 'solar_radiation', 'humidity', 'baro']
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#LISTA COM INDICES A SEREM DESCARTADOS (MEDIA DOS ULTIMOS 60 MINUTOS)
descartaveis = 'M60'
#--------------------------------------------------------------------------------------------------



#--------------------------------------------------------------------------------------------------
#PERCORRENDO AS ENTRADAS NO DIRETÓRIO caminho
for entrada in entradas:
	#--------------------------------------------------------------------------------------------------
	#VERIFICANDO OS ARQUIVOS .txt DISPONIVEIS NO CAMINHO INFORMADO
	if entrada.endswith(".txt"):
	#--------------------------------------------------------------------------------------------------



		#--------------------------------------------------------------------------------------------------
		#ARRAYS PARA AUXILIAR NO CONTROLE DO PROGRAMA
		controle = []
		controle_2 = []
		#--------------------------------------------------------------------------------------------------



		#--------------------------------------------------------------------------------------------------
		#ABRINDO O ARQUIVO E LENDO LINHAS
		arquivo = open(caminho + entrada).readlines()
		#--------------------------------------------------------------------------------------------------



		#--------------------------------------------------------------------------------------------------
		#INFORMANDO O NOME DO ARQUIVO txt
		print ("Lendo arquivo: " + entrada)
		#--------------------------------------------------------------------------------------------------


		#--------------------------------------------------------------------------------------------------
		#PEGANDO AS INFORMAÇÔES DE CADA LINHA
		for i in range(len(arquivo)):
		#--------------------------------------------------------------------------------------------------



			#--------------------------------------------------------------------------------------------------
			#IGNORANDO A PRIMEIRA LINHA (POSSUI UM CABECALHO)
			if i == 0:
				continue
			#--------------------------------------------------------------------------------------------------
			#INFORMANDO O SEPARADOR, NO CASO ';'
			linha = arquivo[i].split(';')
			#--------------------------------------------------------------------------------------------------



			#--------------------------------------------------------------------------------------------------
			#IGNORANDO LINHAS DESCARTAVEIS (MEDIA DOS ULTIMOS 60 MINUTOS)
			if descartaveis in linha[1]:
				continue
			#--------------------------------------------------------------------------------------------------



			#--------------------------------------------------------------------------------------------------
			#ARMAZENANDO DATA_HORA E ESTACAO PARA CONTROLE DO PROGRAMA
			data_estacao_variavel = linha[0]+';'+ linha[1][0:9]
			#--------------------------------------------------------------------------------------------------



			#--------------------------------------------------------------------------------------------------
			#VERIFICANDO SE A DATA_HORA LIDA JA EXISTE NO ARRAY DE CONTRLE, CASO SIM, A LINHA VAI SER PULADA
			if data_estacao_variavel in controle:
				continue
			#--------------------------------------------------------------------------------------------------



			#--------------------------------------------------------------------------------------------------
			#PERCORRENDO O ARRAY estacoes
			for a in range(len(estacoes)):
			#--------------------------------------------------------------------------------------------------



				#--------------------------------------------------------------------------------------------------
				#CASO ALGUM DOS ITENS NO ARRAY estacoes ESTEJA NA LINHA - VALIDO PARA AS ESTAÇÕES 'EMQAM1E01', 'EMQAM2E02' E 'EMQAM3E03'
				if estacoes[a] in linha[1]:
				#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#INSERINDO A DATA_HORA QUE ESTA SENDO TRABALHADA AO ARRAY DE CONTROLE
					controle.append(data_estacao_variavel)
					insercao = []
					aux = []
					#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#INSERINDO A DATA_HORA NO ARRAY AUXILIAR
					aux.append(linha[0])
					#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#INSERINDO A ALTURA NO ARRAY AUXILIAR
					aux.append(10)
					#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#INSERINDO O NOME DA ESTACAO NO ARRAY AUXILIAR
					for j in range(len(estacoes)):
						if estacoes[j] in linha[1]:
							aux.append(j+2) #estacoes[j] -- 'EMQAM1E01' = 2, 'EMQAM2E02' = 3, 'EMQAM3E03' = 4
							data_estacao = linha[0] + ';' + estacoes[j]
					#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#TROCANDO VIRGULA POR PONTO E AREDONDADNO PARA UMA CASA DECIMAL
					arredondar = float(linha[2].replace(',', '.'))
					aux.append(round(arredondar,1))
					#--------------------------------------------------------------------------------------------------


					
					#--------------------------------------------------------------------------------------------------
					#BUSCANDO E INSERINDO AS DEMAIS VARIAVEIS CORRESPONDENTES A MESMA DATA_HORA NO ARRAY AUXILIAR
					for l in range(i+1,len(arquivo)):
						if data_estacao in arquivo[l]:
					#--------------------------------------------------------------------------------------------------



							#--------------------------------------------------------------------------------------------------
							#INFORMANDO O SEPARADOR, NO CASO ';'
							linha_nova = arquivo[l].split(';')
							#--------------------------------------------------------------------------------------------------



							#--------------------------------------------------------------------------------------------------
							#ARREDONDANDO OS VALORES OBITIDOS NO ARQUIVO .txt E ARMAZENANDO OS VALORES NO ARRAY AUXILIAR
							arredondar = float(linha_nova[2].replace(',', '.'))
							aux.append(round(arredondar,1))
							#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#ADICIONANDO VALORES DAS VARIÁVEIS OBTIDAS NO BANCO DE DADOS
					dic = {'sms_llwas_id':1, 'date':aux[0],'wind_speed':aux[3], 'wind_direction':aux[4], 'temperature':aux[5]}
					x = requests.post(url, data = dic)
					print(x.text)
					#--------------------------------------------------------------------------------------------------
			#--------------------------------------------------------------------------------------------------



			#--------------------------------------------------------------------------------------------------
			#CASO TemperatureM05 NA LINHA - VALIDO PARA ESTACÃO EMTERNIUM
			if linha[1] == 'TemperatureM05':
			#--------------------------------------------------------------------------------------------------
				


				#--------------------------------------------------------------------------------------------------
				#PERCORRENDO O A PARTIR DA POSICÃO i E INFORMANDO O ARRAY AUXILIAR
				for n in range(i,len(arquivo)):
					aux = []
				#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#INFORMANDO O SEPARADOR, NO CASO ';'
					linha = arquivo[n].split(';')
					#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#INFORMANDO CONDIÇÃO PARA TRABALHO - SENDO HORA JA TRABALHADA, PULAR
					if linha[0] in controle_2:
						continue
					#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#NÃO SENDO ATENDIDA A CONDIÇÃO DA PARADA
					else:
					#--------------------------------------------------------------------------------------------------



						#--------------------------------------------------------------------------------------------------
						#INSERINDO A DATA_HORA QUE ESTA SENDO TRABALHADA AO ARRAY DE CONTROLE
						data_hora_emternium = linha[0]						
						controle_2.append(linha[0])
						#--------------------------------------------------------------------------------------------------



						#--------------------------------------------------------------------------------------------------
						#INSERINDO A DATA_HORA E ALTURA NO ARRAY AUXILAR
						aux.append(linha[0])
						aux.append(10)
						#--------------------------------------------------------------------------------------------------



						#--------------------------------------------------------------------------------------------------
						#INSERINDO O NOME DA ESTACAO NO ARRAY AUXILIAR - 1 CORRESPONDE A ESTAÇÃO EMTERNIUM
						aux.append(1) #'EMTERNIUM'
						#--------------------------------------------------------------------------------------------------



						#--------------------------------------------------------------------------------------------------
						#BUSCANDO E INSERINDO VARIAVEIS CORRESPONDENTES A MESMA DATA_HORA NO ARRAY AUXILIAR
						for p in range(i,len(arquivo)):
							if data_hora_emternium in arquivo[p]:
								#--------------------------------------------------------------------------------------------------
								#INFORMANDO O SEPARADOR, NO CASO ';'
								linha_2 = arquivo[p].split(';')
								#--------------------------------------------------------------------------------------------------



								#--------------------------------------------------------------------------------------------------
								#ARREDONDANDO OS VALORES OBITIDOS NO ARQUIVO .txt
								arredondar = float(linha_2[2].replace(',', '.'))
								aux.append(round(arredondar,1))
								#--------------------------------------------------------------------------------------------------
						#--------------------------------------------------------------------------------------------------



					#--------------------------------------------------------------------------------------------------
					#ADICIONANDO VALORES DAS VARIÁVEIS OBTIDAS NO BANCO DE DADOS
					dic = {'sms_llwas_id':aux[2], 'date': aux[0], 'estacao':aux[2],'temperature':aux[3], 'precipitation':aux[4], 'wind_speed':aux[5], 'wind_direction':aux[6], 'burst':aux[7], 'solar_radiation':aux[8], 'humidity':aux[9], 'pressure':aux[10]}
					x = requests.post(url, data = dic)
					print(x.text)
					#--------------------------------------------------------------------------------------------------


		#MOVENDO O ARQUIVO LIDO PARA OUTRA PASTA
		# shutil.move(str(caminho) + str(entrada),str(destino) + str(entrada))

